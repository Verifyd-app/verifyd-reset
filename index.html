<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Verifyd – Reset Password</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body      { background:#1d1c1a; color:#fff; font-family:Arial; }
    #wrapper  { max-width:400px; margin:40px auto; padding:30px; border-radius:12px;
                background:#1d1c1a; }
    input     { width:100%; padding:14px; margin:12px 0;
                border-radius:8px; border:none; font-size:16px; }
    button    { background:#0070f3; width:100%; padding:14px; border:none;
                border-radius:8px; font-size:16px; color:#fff; cursor:pointer; }
    #msg      { margin-top:20px; text-align:center; }
    #success  { display:none; text-align:center; margin-top:30px; }
  </style>
</head>
<body>
  <div id="wrapper">
    <h2 style="text-align:center;color:#0070f3">Reset your password</h2>

    <!-- ①  form section -->
    <div id="form">
      <input id="pw" type="password" placeholder="New password" />
      <button id="btn" disabled>Update password</button>
      <div id="msg"></div>
    </div>

    <!-- ②  success section -->
    <div id="success">
      <div style="font-size:48px;color:#00c851">✔️</div>
      <h3>Password updated!</h3>
      <p>You can now sign in with your new password!</p>
    </div>
  </div>

  <!-- ③  Supabase UMD bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <!-- ④  Logic (runs only after DOM is parsed) -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[reset-page] DOMContentLoaded');

    const SupabaseFactory = window.supabase;
    if (!SupabaseFactory) {
      console.error('Supabase UMD factory not found'); return;
    }

    const supabaseClient = SupabaseFactory.createClient(
      'https://qcsxqutctqougpbdlvdq.supabase.co',   // ← your Supabase URL
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjc3hxdXRjdHFvdWdwYmRsdmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNzMwMzAsImV4cCI6MjA2MDg0OTAzMH0.ERBUhLr3Q6A2Rlauy42MABPehFztLKR6_E2IgR7r_1A'                               // ← your anon key
    );
    console.log('[reset-page] supabaseClient created');

    // grab elements (they now exist)
    const btn     = document.getElementById('btn');
    const pw      = document.getElementById('pw');
    const msg     = document.getElementById('msg');
    const formBox = document.getElementById('form');
    const okBox   = document.getElementById('success');

    // check session from implicit-grant fragment
    const { data, error } = await supabaseClient.auth.getSession();
    console.log('[session-check]', data.session, error);
    if (!data.session || error) {
      msg.textContent = 'Session not found. Please use the link from your email.';
      return;
    }
    btn.disabled = false;

    // update password
    btn.addEventListener('click', async () => {
      const newPw = pw.value.trim();
      if (newPw.length < 6) {
        msg.textContent = 'Password must be at least 6 characters.'; return;
      }
      btn.disabled = true; msg.textContent = 'Updating…';

      const { error: updErr } =
        await supabaseClient.auth.updateUser({ password: newPw });

      if (updErr) {
        msg.textContent = updErr.message || 'Something went wrong.';
        btn.disabled = false;
      } else {
        formBox.style.display = 'none'; okBox.style.display = 'block';
      }
    });
  });
  </script>
</body>
</html>
