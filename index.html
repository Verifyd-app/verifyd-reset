  <!-- Load Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script>
    console.log('[reset-page] script loaded');

    // 1) Grab the factory object
    const SupabaseFactory = window.supabase;
    if (!SupabaseFactory) {
      document.getElementById('msg').textContent =
        'Internal error: auth library failed to load.';
      throw new Error('Supabase UMD not found');
    }

    // 2) Instantiate your client
    const supabaseClient = SupabaseFactory.createClient(
      'https://qcsxqutctqougpbdlvdq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // ← your anon key
    );
    window.supabaseClient = supabaseClient;
    console.log('[reset-page] supabaseClient created');

    // 3) Wire up the UI
    const btn     = document.getElementById('btn');
    const pw      = document.getElementById('pw');
    const msg     = document.getElementById('msg');
    const formBox = document.getElementById('form');
    const okBox   = document.getElementById('success');

    // 4) Wait for the implicit‐grant tokens in the URL fragment
    (async () => {
      const { data, error } = await supabaseClient.auth.getSession();
      console.log('[session-check]', data.session, error);
      if (!data.session || error) {
        msg.textContent = 'Session not found—use the link from your email.';
      } else {
        btn.disabled = false;
      }
    })();

    // 5) Update password on click
    btn.addEventListener('click', async () => {
      const newPw = pw.value.trim();
      if (newPw.length < 6) {
        msg.textContent = 'Password must be at least 6 characters.';
        return;
      }
      btn.disabled = true;
      msg.textContent = 'Updating…';

      const { error } = await supabaseClient.auth.updateUser({ password: newPw });
      if (error) {
        msg.textContent = error.message;
        btn.disabled = false;
      } else {
        formBox.style.display = 'none';
        okBox.style.display  = 'block';
      }
    });
  </script>
</body>
</html>
